<!-- Contenedor Principal que envuelve todo el contenido de la página -->
<div class="page-content-container p-4 sm:p-8 bg-gray-100 min-h-screen">
    <!-- Encabezado y Controles Principales -->
    <header class="mb-8 p-6 bg-white shadow-xl rounded-xl">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Panel de Contactos</h1>
        <p class="text-gray-600">
            Gestión centralizada de todos los contactos de tu CRM.
        </p>

        <div class="mt-4 flex flex-wrap gap-3">
            <!-- Botón de Recarga -->
            <!-- Usamos cargarContactos() -->
            <button
                class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out"
                (click)="cargarContactos()"
                [disabled]="isLoading()"
            >
                @if (isLoading()) { Cargando... } @else { Recargar Contactos }
            </button>

            <!-- Botón para Añadir Cliente (Modal) -->
            <!-- Usamos openNewContactModal() -->
            <button
                class="px-4 py-2 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 transition duration-150 ease-in-out"
                (click)="openNewContactModal()"
            >
                Añadir Contacto
            </button>
        </div>
    </header>

    <!-- Barra de Búsqueda y Filtros -->
    <div class="mb-6 flex flex-col md:flex-row gap-4">
        <!-- Input de Búsqueda -->
       
        <input
            type="text"
            placeholder="Buscar por nombre o email..."
            class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" 
            [value]="searchTerm()"
            (input)="handleSearchInput($event)"
        />

        <!-- Select de Estado -->
        
        <select
            class="p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 md:w-48"
            [value]="filterStatus()"
            (change)="handleStatusChange($event)"
        >
            <option value="Todos">Todos los Estados</option>
            <option value="Activo">Activo</option>
            <option value="Potencial">Potencial</option>
            <option value="Inactivo">Inactivo</option>
        </select>
    </div>

    <!-- Indicador de Carga y Mensajes de Estado -->
    @if (isLoading()) {
        <div class="flex items-center justify-center p-10 bg-white rounded-xl shadow-lg">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-indigo-600 font-medium">Cargando contactos...</span>
        </div>
    } @else if (error()) {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative shadow-lg" role="alert">
            <strong class="font-bold">Error de Carga: </strong>
            <span class="block sm:inline">{{ error() }}</span>
        </div>
    } @else if (filteredContacts().length === 0) {
        <p class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-lg">
             @if (contacts().length > 0) {
                No se encontraron contactos que coincidan con los filtros.
             } @else {
                No hay contactos registrados aún.
             }
        </p>
    } @else {
        <!-- Contenedor Principal del Listado de Clientes (Tabla Grid) -->
        <div class="bg-white shadow-lg rounded-xl overflow-x-auto">
            <div
                class="table-header grid grid-cols-7 gap-4 p-4 font-semibold text-sm text-gray-700 border-b border-gray-200 bg-gray-50 hidden md:grid"
            >
                <div class="col-span-1">ID</div>
                <div class="col-span-2">Nombre del Contacto/Empresa</div>
                <div class="col-span-1">Email</div>
                <div class="col-span-1">Teléfono</div>
                <div class="col-span-1 text-center">Estado</div>
                <div class="col-span-1 text-center">Acciones</div>
            </div>

            <!-- Iteración de Contactos -->
            @for (contact of filteredContacts(); track contact.id) {
            <div
                class="table-row grid grid-cols-7 gap-4 p-4 border-b border-gray-100 hover:bg-indigo-50 transition duration-100 ease-in-out cursor-pointer items-center"
            >
                <!-- ID -->
                <div class="col-span-1 text-sm text-gray-500 hidden md:block">
                    {{ contact.id }}
                </div>

                <!-- Nombre y Datos Móviles -->
                <div class="col-span-full md:col-span-2">
                    <p class="font-medium text-gray-900">{{ contact.nombre }}</p>
                    <p class="text-xs text-gray-500">
                        <span class="md:hidden">ID: {{ contact.id }} | </span>
                        Empresa: {{ contact.empresa }}
                    </p>
                    <div class="md:hidden mt-1 text-sm text-gray-600">
                        Email: {{ contact.email }}
                    </div>
                </div>

                <!-- Email (Escritorio) -->
                <div class="col-span-1 text-sm text-gray-600 truncate hidden md:block">
                    {{ contact.email }}
                </div>

                <!-- Teléfono (Escritorio) -->
                <div class="col-span-1 text-sm text-gray-600 hidden md:block">
                    {{ contact.telefono }}
                </div>

                <!-- Estado -->
                <div class="col-span-2 md:col-span-1 text-left md:text-center">
                    <span
                        [class]="
                            'inline-flex items-center rounded-full px-3 py-1 text-xs font-medium ring-1 ring-inset ' +
                            getStatusClasses(contact.estado)
                        "
                    >
                        {{ contact.estado }}
                    </span>
                </div>

                <!-- Acciones -->
                <div class="col-span-2 md:col-span-1 text-right md:text-center">
                    <button class="text-indigo-600 hover:text-indigo-800 font-medium" (click)="openEditModal(contact)">
                        Ver Detalle
                    </button>
                </div>
            </div>
            } @empty {
            <p class="p-6 text-center text-gray-500">
                No se encontraron contactos que coincidan con los filtros.
            </p>
            }
        </div>
    }
</div>

<!-- ******************************* MODAL DE EDICIÓN / CREACIÓN ******************************* -->
<!-- Usamos isModalOpen() y editingContact() de tu lógica original -->
@if (isModalOpen() && editingContact(); as contact) {
  <div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Overlay/Backdrop -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" (click)="closeEditModal()"></div>
    
    <!-- Contenedor del Modal -->
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      
      <!-- Contenido del Modal -->
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <!-- Título Dinámico -->
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
            @if (contact.id > 0) {
                Editar Contacto: {{ contact.nombre }}
            } @else {
                Añadir Nuevo Contacto
            }
          </h3>
          
          <!-- Formulario de Edición (Corregido para pasar solo $event) -->
          <div class="mt-4 space-y-4">
            
            <!-- Campo Nombre -->
            <div class="flex flex-col">
              <label for="nombre" class="text-sm font-medium text-gray-700">Nombre</label>
              <input 
                type="text" 
                id="nombre" 
                [value]="contact.nombre" 
                (input)="updateEditingContact('nombre', $event)" 
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
              >
            </div>

            <!-- Campo Email -->
            <div class="flex flex-col">
              <label for="email" class="text-sm font-medium text-gray-700">Email</label>
              <input 
                type="email" 
                id="email" 
                [value]="contact.email" 
                (input)="updateEditingContact('email', $event)" 
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
              >
            </div>

            <!-- Campo Empresa -->
            <div class="flex flex-col">
              <label for="empresa" class="text-sm font-medium text-gray-700">Empresa</label>
              <input 
                type="text" 
                id="empresa" 
                [value]="contact.empresa" 
                (input)="updateEditingContact('empresa', $event)" 
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
              >
            </div>

            <!-- Campo Teléfono -->
            <div class="flex flex-col">
              <label for="telefono" class="text-sm font-medium text-gray-700">Teléfono</label>
              <input 
                type="text" 
                id="telefono" 
                [value]="contact.telefono" 
                (input)="updateEditingContact('telefono', $event)" 
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
              >
            </div>

            <!-- Campo Estado -->
            <div class="flex flex-col">
              <label for="estado" class="text-sm font-medium text-gray-700">Estado</label>
              <select 
                id="estado" 
                [value]="contact.estado" 
                (change)="updateEditingContact('estado', $event)" 
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
              >
                <option value="Activo">Activo</option>
                <option value="Potencial">Potencial</option>
                <option value="Inactivo">Inactivo</option>
              </select>
            </div>

          </div>
          
        </div>
        
        <!-- Botones del Modal -->
        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
          <button 
            type="button" 
            (click)="saveContactChanges()"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm transition"
          >
            Guardar Cambios
          </button>
          <button 
            type="button" 
            (click)="closeEditModal()"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>
}